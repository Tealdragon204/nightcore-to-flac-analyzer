# ============================================================
# Nightcore Audio Analysis Tool — Conda Environment
# ============================================================
# Recommended approach for Arch-derivative Linux systems where
# getting CUDA libraries on PATH can be fragile with plain pip.
#
# Create environment:
#   conda env create -f environment.yml
#
# Activate:
#   conda activate nightcore-analyzer
#
# Install CREPE (setuptools>=81 removed pkg_resources; pin to <81 first):
#   pip install "setuptools<81"
#   pip install --no-build-isolation crepe
#
# Verify:
#   python verify_cuda.py
#
# Remove environment (uninstall):
#   conda deactivate
#   conda env remove -n nightcore-analyzer
# ============================================================

name: nightcore-analyzer

channels:
  - conda-forge
  - nvidia          # provides cuda-toolkit, cudnn packages
  - defaults

dependencies:
  # Core Python runtime
  - python=3.11
  - pip
  - "setuptools<81"        # setuptools 81+ removed pkg_resources; CREPE requires it

  # NumPy/SciPy pinned below 2.x for TensorFlow/librosa compatibility
  - numpy>=1.24,<2.0
  - scipy>=1.11

  # Visualisation
  - matplotlib>=3.8.0

  # Progress bars
  - tqdm>=4.66.0

  # ── IMPORTANT: do NOT run `conda install cuda-toolkit` or
  # `conda install -c nvidia cudnn` into this environment.
  # tensorflow[and-cuda] (below) bundles its own CUDA 12 wheels via pip
  # (nvidia-cuda-runtime-cu12, nvidia-cudnn-cu12, etc.).  Installing a
  # conda-managed CUDA 13 toolkit alongside those pip wheels creates a
  # version conflict (libcudart.so.13 vs libcudart.so.12) and makes the
  # environment very hard to debug.  If you already did this, recreate
  # the environment from scratch.

  # Everything else via pip — avoids conda-forge package name ambiguity
  # for audio libs and pip-only packages
  - pip:
    # TensorFlow with bundled CUDA 12 wheels.
    # NOTE: libcuda.so.1 (driver stub) still comes from the system NVIDIA
    # driver package and must be on LD_LIBRARY_PATH.  Run the one-time
    # helper after env creation:
    #   bash setup_conda_libcuda.sh
    - "tensorflow[and-cuda]>=2.15.0,<2.17.0"

    # NOTE: CREPE is NOT listed here — setuptools 81+ removed pkg_resources,
    # which CREPE's legacy setup.py imports. The conda dep above pins
    # setuptools<81. Install CREPE manually after env creation:
    #   pip install --no-build-isolation crepe

    # Audio I/O — pip names are unambiguous; conda-forge names vary by version
    - "librosa>=0.10.1"
    - "soundfile>=0.12.1"
    - "audioread>=3.0.0"

    # Rubber Band Python bindings
    # Requires rubberband binary: sudo pacman -S rubberband
    - "pyrubberband>=0.3.0"

    # PyQt6 — use pip; conda-forge 'pyqt' package is PyQt5, not PyQt6
    - "PyQt6>=6.6.0"

    # Fast real-time Qt plotting
    - "pyqtgraph>=0.13.4"
